#! /usr/bin/env python3
# -*- coding: UTF-8 -*-

import argparse
import os
import subprocess
import shlex
import tempfile
import sys # sys.stderr


### Global options

# Print executed commands
print_commands = False

# Paths to programs to call

cpp_prog = 'cpp'
cpp_flags = []
cpp_verbose = 0

optimizer_prog = 'pencil-optimizer'
optimizer_flags = []
optimizer_verbose = 0

ppcg_prog = 'ppcg'
ppcg_flags = []
ppcg_verbose = 0

cc_prog = 'cc'
cc_flags = []
cc_verbose = 0



def print_command(cmd, *args):
	if print_commands:
		shortcmd = os.path.basename(cmd) if print_commands_baseonly else shlex.quote(cmd)
		print('$ ' + shortcmd + ' ' + ' '.join([shlex.quote(s) for s in args]),file=sys.stderr)

def invoke(cmd, *args):
	print_command(cmd, *args)
	subprocess.check_call([cmd] + list(args))


def verbosity(lvl):
	if lvl > 0:
		return ['-' + 'v'.repeat(lvl)]
	return []


def call_cpp(*args):
	invoke(cpp_prog, *args)
def invoke_cpp(*args):
	allargs = verbosity(cpp_verbose)
	allargs += cpp_flags
	allargs += args
	call_cpp(*allargs)

def call_ppcg(*args):
	invoke(ppcg_prog, *args)
def invoke_ppcg(*args):
	allargs = verbosity(ppcg_verbose)
	allargs += ppcg_flags
	allargs += args
	call_ppcg(*args)

def call_optimizer(*args):
	invoke(optimizer_prog, *args)
def invoke_optimizer(*args):
	allargs = []
	if optimizer_verbose:
		allargs += ['-dump-passes']
	allargs += optimizer_flags
	allargs += args
	call_optimizer(*allargs)

def call_cc(*cmdline):
	invoke(cc_prog, *cmdline)
def invoke_cc(*cmdline):
	extra_flags = verbosity(cc_verbose)
	extra_flags += cc_flags
	extra_flags += cmdline
	call_cc(*extra_flags)


def print_versions():
	print("PENCIL driver ", '''@GIT_HEAD_ID@''')
	print()
	
	if cpp_prog:
		print("cpp:", cpp_prog)
		try:
			call_cpp('--version')
		except:
			pass
		
	if optimizer_prog:
		print("optimizer: ", optimizer_prog)
		try:
			call_optimizer('--version')
		except e:
			pass

	if ppcg_prog:
		print("ppcg: ", ppcg_prog)
		try:
			call_ppcg('--version')
		except:
			pass

	if cc_prog:
		print("cc: ", cc_prog)
		try:
			call_cc('--version')
		except:
			pass


def locate(filename, paths, default=None):
	for path in paths:
		if not path:
			continue
		filepath = os.path.join(path,filename)
		if os.path.isfile(filepath):
			print('FOUND: ',filepath)
			return os.path.abspath(filepath)
		else:
			print('TEST:  ',filepath)
	return default



def main():
	# Interfacing with environment variables
	CC = os.environ.get('CC')
	CPP = os.environ.get('CPP')
	CFLAGS = shlex.split(os.environ.get('CFLAGS') or '')
	CPPFLAGS = shlex.split(os.environ.get('CPPFLAGS') or '')
	LFLAGS = shlex.split(os.environ.get('LFLAGS') or '')
	
	
	# Interfacing with autoconf
	with_ppcg='''@with_ppcg@'''
	with_pencil='''@with_pencil@'''
	prefix='''@prefix@'''
	eprefix='''@eprefix@'''
	abs_builddir='''@abs_builddir@'''
	abs_srcdir='''@abs_srcdir@'''
	includedir='''@includedir@'''.replace('''${prefix}''', prefix)
	bindir='''@bindir@'''

	pencilcc_build=os.path.join(abs_builddir,'pencilcc.py')
	print(os.path.abspath(sys.argv[0]) )
	print(os.path.abspath(pencilcc_build))
	is_build=os.path.abspath(sys.argv[0]) == os.path.abspath(pencilcc_build)

	ocl_utilities_cflags = []
	ocl_utilities_cppflags = []
	pencil_h_cppflags = []
	
	global ppcg_prog
	if is_build:
		# Script runs from build directory
		if with_ppcg=='no':
			print("No ppcg")
			ppcg_prog=None
		elif with_ppcg=='bundled' or with_ppcg=='build':
			if with_ppcg=='bundled':
				print("Bundled ppcg")
				PPCG_BUILDDIR=os.path.join(abs_builddir,'ppcg')
				PPCG_SRCDIR=os.path.join(abs_srcdir,'ppcg')
			elif with_ppcg=='build':
				print("Builddir ppcg")
				PPCG_BUILDDIR='''@PPCG_BUILDDIR@'''
				PPCG_SRCDIR='''@PPCG_SRCDIR@'''
			ppcg_prog=os.path.join(PPCG_BUILDDIR,'ppcg')
			#ocl_utilities_c = os.path.join(PPCG_SRCDIR, 'ocl_utilities.c')
			#ocl_utilities_h = os.path.join(PPCG_SRCDIR, 'ocl_utilities.h')
			ocl_utilities_cppflags += ['-I', PPCG_SRCDIR]
		else: # System
			print("System ppcg")
			ppcg_prog='ppcg'
		ocl_utilities_cflags += [os.path.join(PPCG_SRCDIR,'ocl_utilities.c')]
		pencil_h_cppflags += ['-I', os.path.join(abs_srcdir,'pencil-util','include')]
	else:
		print("Installed ppcg")
		# Script runs from installed location (or has never been configured); Ignore build path
		if bindir:
			ppcg_prog=os.path.join(bindir,'ppcg')
		if includedir:
			ocl_utilities_cppflags += ['-I', includedir]
			pencil_h_cppflags += ['-I', includedir]
			
		#ocl_utilities_c = 'ocl_utilities.c' #TODO: Install (or make it a lib)
		#ocl_utilities_h = locate('ocl_utilities.h', paths=[includedir], default='ocl_utilities.h')


	global optimizer_prog
	if is_build:
		if with_pencil=='no':
			print("No pencil-optimizer")
			optimizer_prog=None
		elif with_pencil=='bundled' or with_pencil=='build': 
			if with_pencil=='bundled':
				print("Bundled pencil-optimizer")
				PENCIL_BUILDDIR=os.path.join(abs_builddir,'pencil')
				PENCIL_SRCDIR=os.path.join(abs_srcdir,'pencil')
			elif with_pencil=='build':
				print("Builddir pencil-optimizer")
				PENCIL_BUILDDIR='''@PENCIL_BUILDDIR@'''
				PENCIL_SRCDIR='''@PENCIL_SRCDIR@'''
			optimizer_prog=os.path.join(PENCIL_BUILDDIR,'pencil-optimizer')
		else:
			print("System pencil-optimizer")
			optimizer_prog='pencil-optimizer'
	else:
		print("Installed pencil-optimizer")
		if bindir:
			optimizer_prog=os.path.join(bindir,'pencil-optimizer')

	

	parser = argparse.ArgumentParser(description="Driver for PENCIL.  Executes pencil-optimizer, ppcg and compiler as required.")
	parser.add_argument('-v', '--verbose', action='count', default=0)
	parser.add_argument('--version', action='store_true', help="Print versions of involved programs")
	parser.add_argument('--show-commands', action='store_true', help="Print executed commands")
	parser.add_argument('--show-commands-baseonly', action='store_true', help="Do not print full command path")
	parser.add_argument('--noselfupdate', dest='selfupdate', default=True, action='store_false', help="Do not try to update yourself")
	
	parser.add_argument('--pencil-cpp-path', metavar='CC', default=CPP or 'cpp')
	
	if optimizer_prog is not None:
		parser.add_argument('--pencil-opt', action='store_true', default=False, help="Use pencil-optimizer in toolchain")
		parser.add_argument('--pencil-opt-path', metavar='OPTIMIZER', help="Path to optimizer (default: " + optimizer_prog + ")")
	
	if ppcg_prog is not None:
		parser.add_argument('--pencil-ppcg', action='store_true', default=False, help="Use ppcg in toolchain")
		parser.add_argument('--pencil-ppcg-path', metavar='PPCG', help="Path to ppcg (default: " + ppcg_prog + ")")
	
	parser.add_argument('--pencil-cc-path', metavar='CC', default=CC or 'cc')

	parser.add_argument('--pencil-runtime', action='store_true', help="Use the PENCIL OpenCL runtime")

	# Compatibility arguments
	parser.add_argument('-o', metavar='OUTPUT')


	known, unknown = parser.parse_known_args() # Beware of prefix matching: https://mail.python.org/pipermail/python-dev/2013-November/130601.html http://bugs.python.org/issue14910
	print(known,unknown)

	global print_commands,print_commands_baseonly
	print_commands = (known.verbose > 0) or known.show_commands or known.show_commands_baseonly
	print_commands_baseonly = known.show_commands_baseonly

	scriptdir =  os.path.dirname(sys.argv[0])
	if known.selfupdate and (os.path.isfile(os.path.join(scriptdir, 'Makefile')) or os.path.isfile(os.path.join(scriptdir, 'makefile'))):
		invoke('make','pencilcc.py') #TODO: chdir scriptdir
		cmdline=[sys.argv[0], '--noselfupdate'] + sys.argv[1:]
		print_command(*cmdline)
		rtn = subprocess.call(cmdline)
		exit(rtn)

 
	global cpp_prog,cpp_flags,cpp_verbose
	cpp_prog = known.pencil_cpp_path or CPP or cpp_prog
	cpp_flags = CPPFLAGS
	cpp_verbose = max(cpp_verbose, known.verbose - 1)
	
	global optimizer_prog,optimizer_flags,optimizer_verbose
	optimizer_prog = known.pencil_opt_path or optimizer_prog
	optimizer_verbose = max(optimizer_verbose, known.verbose-1)
	
	global ppcg_verbose 
	ppcg_prog = known.pencil_ppcg_path or ppcg_prog
	if known.verbose > 1:
		ppcg_verbose = known.verbose - 1
	
	global cc_prog,cc_flags,cc_verbose
	cc_prog = known.pencil_cc_path or cc_prog
	cc_flags = [] + CPPFLAGS + CFLAGS
	if known.verbose > 1:
		cc_verbose = known.verbose - 1
	
	use_ppcg = known.pencil_ppcg or known.pencil_ppcg_path
	use_optimizer = known.pencil_opt or known.pencil_opt_path
	use_runtime = known.pencil_runtime
	
	if known.version:
		print_versions()
		exit(0)

	
	files = []
	ccargs = []
	
	for arg in unknown:
		if os.path.isfile(arg):
			files.append(arg)
		else:
			ccargs.append(arg)
		
	if known.o is not None:
		ccargs += ['-o', known.o]
		
	#print("Input files:", files)
	#print("No special handling for (passed to cc):", ccargs)
	
	if not files:
		print("No input files")
		exit(4)
		


	#with tempfile.TemporaryDirectory(prefix='pencil.') as tmpdir:
	tmpdir = tempfile.mkdtemp(prefix='pencil.')
	while True:
		outfiles = []
		for infile in files:
			ispencil = infile.endswith('.pencil.c')
			basename = os.path.basename(infile)
			rootname = os.path.splitext(basename)[0]
			file = infile
			
			if use_optimizer and ispencil:
				tmpsubdir = tempfile.mkdtemp(prefix='opt.',dir=tmpdir)
				
				cppfile = os.path.join(tmpsubdir, basename + '.i')
				cppargs = []
				cppargs += ['-D__PENCIL__=1']
				cppargs += pencil_h_cppflags
				cppargs += ['-P',file,'-o', cppfile]
				invoke_cpp(*cppargs)

				optfile =  os.path.join(tmpsubdir, rootname + '.opt.c')
				invoke_optimizer(cppfile,'-o',optfile)
				file = optfile
			
			if use_ppcg:
				tmpsubdir = tempfile.mkdtemp(prefix='ppcg.',dir=tmpdir)
				outfile = os.path.join(tmpsubdir, basename)
				ppcgargs = []
				ppcgargs += ['-D__PENCIL__=2']
				ppcgargs += ['--target=opencl']
				if ispencil:
					ppcgargs += ['--pet-autodetect']
				ppcgargs += pencil_h_cppflags
				ppcgargs += [file, '-o', outfile]
				invoke_ppcg(*ppcgargs)
				file = outfile
				
			outfiles.append(file)

		invoke_cc(*(['-std=c99', '-D__PENCIL__=3'] + ccargs + pencil_h_cppflags + ocl_utilities_cppflags + ocl_utilities_cflags + outfiles + ['-lm', '-lOpenCL']))
		break


if __name__ == '__main__':
	main()
